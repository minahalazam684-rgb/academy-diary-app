<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toppers' Inn Academy Daily Diary</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        /* Critical: Ensure button is treated as interactive, not for text selection */
        .btn-add-content { user-select: none !important; cursor: pointer !important; }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-xl rounded-xl mt-6 mb-12">

        <!-- Header -->
        <header class="pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-blue-900">TOPPERS' INN ACADEMY Daily Diary</h1>
            <p class="mt-1 text-sm text-gray-600" id="dateDisplay">Viewing entries for: Loading Date...</p>
            <p class="text-xs text-gray-500 mt-0" id="userIdDisplay">User ID: N/A</p>
        </header>

        <!-- Message/Status Banner Area -->
        <div id="messageArea" class="mt-4">
            <!-- Messages (Success/Error/Loading) will appear here -->
        </div>

        <!-- Main Content Area -->
        <main class="mt-6 space-y-6">

            <!-- Class Selection Dropdown -->
            <div class="flex items-center space-x-4">
                <label for="classSelect" class="text-lg font-semibold text-gray-700">Select Class & Group:</label>
                <select id="classSelect" onchange="loadClassData()" class="p-2 border border-blue-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full md:w-64 transition duration-150 ease-in-out">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- Subjects Container (Where subject cards are rendered) -->
            <div id="subjectsContainer" class="space-y-6">
                <p class="text-center text-gray-500 py-10">Select a class to view subjects.</p>
            </div>
        </main>
    </div>

    <!-- Content Modal (Hidden by default) -->
    <div id="contentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-11/12 max-w-lg transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-blue-800">Add Daily Record for <span id="modalSubjectTitle"></span></h2>
                <!-- Close Button -->
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-900 transition-colors duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <input type="hidden" id="modalSubjectId">
            <input type="hidden" id="modalSubjectName">

            <div class="mb-4">
                <label for="contentInput" class="block text-sm font-medium text-gray-700 mb-2">Daily Content:</label>
                <textarea id="contentInput" rows="6" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Enter the content covered in today's class..."></textarea>
            </div>

            <div class="flex justify-end space-x-3 pt-2">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                    Cancel
                </button>
                <button onclick="saveContent()" id="saveButton" class="px-6 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 shadow-md transition duration-150 disabled:opacity-50" disabled>
                    Save Entry
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports (MUST use type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, where, 
            serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Log all Firestore debug messages (useful for troubleshooting)
        setLogLevel('Debug');

        // Global state
        window.globalState = {
            db,
            auth,
            userId: null,
            appId,
            currentClassId: null,
            classData: {}, // Cache for all class data
            diaryRecords: {}, // Cache for current day's records
            isAuthReady: false,
            // Mock data for classes and subjects based on our timetable
            MOCK_CLASS_DATA: {
                // "1st Year (Science)"
                "1st-year-science": {
                    id: "1st-year-science",
                    name: "1st Year (Science)",
                    subjects: [
                        { id: "physics-1st", name: "Physics", teacher: "Sir Saleem" },
                        { id: "chemistry-1st", name: "Chemistry", teacher: "Miss Alina" },
                        { id: "computer-1st", name: "Computer", teacher: "Miss Minahil" },
                        { id: "biology-1st", name: "Biology", teacher: "Miss Shumaila" },
                    ]
                },
                // "9th Boys"
                "9th-boys": {
                    id: "9th-boys",
                    name: "9th Boys",
                    subjects: [
                        { id: "math-9b", name: "Math", teacher: "Sir Hammad" },
                        { id: "physics-9b", name: "Physics", teacher: "Sir Saleem" },
                        { id: "english-9b", name: "English", teacher: "Sir Zulfiqar" },
                    ]
                },
                // "8th"
                "8th-grade": {
                    id: "8th-grade",
                    name: "8th Grade",
                    subjects: [
                        { id: "english-8", name: "English", teacher: "Miss Sumaira" },
                        { id: "math-8", name: "Math", teacher: "Sir Hammad" },
                        { id: "urdu-8", name: "Urdu", teacher: "Miss Anam" },
                    ]
                }
            }
        };

        // --- Utility Functions ---

        /**
         * Shows a message banner (success, error, or loading).
         * @param {string} text - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message.
         * @param {number} duration - Time in ms to hide the message (0 for permanent).
         */
        function showMessage(text, type, duration = 5000) {
            const messageArea = document.getElementById('messageArea');
            let bgColor, borderColor;

            if (type === 'success') {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-500';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-500';
            } else {
                bgColor = 'bg-blue-100';
                borderColor = 'border-blue-500';
            }

            messageArea.innerHTML = `
                <div id="messageBanner" class="${bgColor} border-l-4 ${borderColor} text-gray-800 p-4 mb-4 rounded-lg flex justify-between items-center transition-all duration-300">
                    <p class="font-medium">${text}</p>
                    <button onclick="document.getElementById('messageBanner').remove()" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;

            if (duration > 0) {
                setTimeout(() => {
                    const banner = document.getElementById('messageBanner');
                    if (banner) banner.remove();
                }, duration);
            }
        }

        /**
         * Gets the Firestore collection path for public (shared) data.
         * @returns {string} The collection path.
         */
        function getDiaryCollectionPath() {
            // Public path: /artifacts/{appId}/public/data/daily_diary
            return `artifacts/${globalState.appId}/public/data/daily_diary`;
        }
        
        /**
         * Gets the current date string in a consistent format (YYYY-MM-DD).
         * For the demo, we are using a fixed date for consistency: November 22, 2025 (a Saturday)
         * @returns {string} The formatted date.
         */
        function getDiaryDate() {
            // Fixed date for a repeatable demo/test scenario
            return "2025-11-22"; 
        }

        /**
         * Formats the date for display.
         */
        function updateDateDisplay() {
            const date = new Date('2025-11-22T00:00:00'); // Use the fixed date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', options);
            document.getElementById('dateDisplay').textContent = `Viewing entries for: ${formattedDate}`;
        }

        // --- Core Application Logic ---

        /**
         * Fetches and initializes the Class/Subject data structure.
         * Populates the class dropdown.
         */
        async function initializeClasses() {
            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">-- Select a Class --</option>';

            // Load mock data into state for immediate use
            globalState.classData = globalState.MOCK_CLASS_DATA;

            // Populate dropdown from MOCK data
            Object.values(globalState.classData).forEach(classItem => {
                const option = document.createElement('option');
                option.value = classItem.id;
                option.textContent = classItem.name;
                select.appendChild(option);
            });
            
            // Auto-select and load a default class for convenience
            const defaultClassId = "1st-year-science";
            if (globalState.classData[defaultClassId]) {
                select.value = defaultClassId;
                await loadClassData(defaultClassId);
            }
        }

        /**
         * Loads the data for the currently selected class and sets up the real-time listener.
         * @param {string | null} classId - The class ID to load, or uses the dropdown value.
         */
        window.loadClassData = async function(classId = null) {
            if (!globalState.isAuthReady) {
                console.warn("Auth not ready. Aborting loadClassData.");
                return;
            }

            const selectedClassId = classId || document.getElementById('classSelect').value;
            globalState.currentClassId = selectedClassId;

            if (!selectedClassId) {
                document.getElementById('subjectsContainer').innerHTML = '<p class="text-center text-gray-500 py-10">Select a class to view subjects.</p>';
                return;
            }

            showMessage(`Loading diary for ${globalState.classData[selectedClassId].name}...`, 'info', 0);

            // Get the Firestore collection reference
            const diaryRef = collection(db, getDiaryCollectionPath());
            
            // We listen for changes in the records for the selected class and today's date
            const q = query(
                diaryRef,
                where("classId", "==", selectedClassId),
                where("date", "==", getDiaryDate())
            );

            // Set up real-time listener
            onSnapshot(q, (snapshot) => {
                const newRecords = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    newRecords[data.subjectId] = {
                        ...data,
                        docId: doc.id
                    };
                });
                globalState.diaryRecords = newRecords;
                renderSubjects();
                showMessage(`Diary records updated in real-time.`, 'success', 3000);
            }, (error) => {
                console.error("Error setting up real-time listener:", error);
                showMessage(`Error loading diary entries: ${error.message}`, 'error', 0);
            });
        }


        /**
         * Renders the subject cards for the currently selected class.
         */
        function renderSubjects() {
            const container = document.getElementById('subjectsContainer');
            const classItem = globalState.classData[globalState.currentClassId];

            if (!classItem) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">Class data not found.</p>';
                return;
            }

            const html = classItem.subjects.map(subject => {
                const record = globalState.diaryRecords[subject.id];
                const content = record ? record.content : 'No daily content recorded yet for this subject.';
                const contentClass = record ? 'text-gray-800' : 'text-gray-500 italic';
                
                // CRITICAL CHANGE: Added onmousedown="return false;" and cursor-pointer class
                return `
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-5 rounded-xl shadow-md transition duration-300 hover:shadow-lg">
                        <div class="flex justify-between items-start">
                            <h3 class="text-2xl font-bold text-blue-900">${subject.name}</h3>
                            <button 
                                class="btn-add-content flex items-center space-x-1 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-105 cursor-pointer"
                                title="Add/Edit today's entry"
                                data-subject-id="${subject.id}"
                                onmousedown="return false;"
                            >
                                Add Content
                            </button>
                        </div>
                        <p class="mt-1 text-sm text-gray-700">Assigned Teacher: <span class="font-semibold">${subject.teacher}</span></p>

                        <div class="mt-4 pt-3 border-t border-blue-200">
                            <h4 class="text-sm font-semibold text-blue-700 uppercase tracking-wider mb-2">DAILY RECORD</h4>
                            <div class="p-3 bg-white rounded-lg border border-blue-100 min-h-[50px]">
                                <p class="${contentClass} whitespace-pre-wrap">${content}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            // After rendering, attach the click handlers using the dedicated function
            attachButtonListeners();
        }
        
        /**
         * Attaches a click event listener to all "Add Content" buttons.
         * This handles the actual call to openModal.
         */
        function attachButtonListeners() {
            const buttons = document.querySelectorAll('.btn-add-content');
            buttons.forEach(button => {
                // Remove existing listener to prevent duplicates
                button.removeEventListener('click', handleAddContentClick); 
                // Add the new listener
                button.addEventListener('click', handleAddContentClick);
            });
        }
        
        /**
         * Handler function for "Add Content" button clicks.
         * @param {Event} event 
         */
        function handleAddContentClick(event) {
            // Prevent default form submission or other unwanted behavior
            event.preventDefault(); 
            // Stop event propagation to ensure no parent element interferes
            event.stopPropagation(); 
            
            const subjectId = event.currentTarget.getAttribute('data-subject-id');
            if (subjectId) {
                // Call the existing openModal function
                openModal(subjectId);
            } else {
                console.error("Button clicked but no subject-id found.");
            }
        }


        // --- Modal & Data Saving Functions (Exposed to window) ---

        /**
         * Opens the content modal for a specific subject.
         * @param {string} subjectId - The ID of the subject to edit.
         */
        window.openModal = function(subjectId) {
            console.log("Attempting to open modal for subject:", subjectId);
            try {
                const classItem = globalState.classData[globalState.currentClassId];
                if (!classItem) throw new Error("Class data not loaded.");
                
                const subject = classItem.subjects.find(s => s.id === subjectId);
                if (!subject) throw new Error("Subject not found.");

                const record = globalState.diaryRecords[subjectId];
                
                // Set modal data
                document.getElementById('modalSubjectId').value = subjectId;
                document.getElementById('modalSubjectTitle').textContent = subject.name; // Corrected ID usage
                document.getElementById('contentInput').value = record ? record.content : '';
                document.getElementById('saveButton').disabled = false;

                // Show the modal with transition effects
                const modal = document.getElementById('contentModal');
                const modalContent = document.getElementById('modalContent');
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modalContent.style.transform = 'scale(1)';
                    modalContent.style.opacity = '1';
                }, 10); // Short delay for transition to start
                
                // Add event listener to close modal on background click
                modal.onclick = (e) => {
                    if (e.target.id === 'contentModal') {
                        closeModal();
                    }
                };

            } catch (error) {
                console.error("Error opening modal:", error);
                showMessage(`Could not open entry form: ${error.message}`, 'error', 5000);
            }
        };

        /**
         * Closes the content modal.
         */
        window.closeModal = function() {
            const modal = document.getElementById('contentModal');
            const modalContent = document.getElementById('modalContent');
            
            // Reverse transition effects
            modal.style.opacity = '0';
            modalContent.style.transform = 'scale(0.95)';
            modalContent.style.opacity = '0';
            
            // Hide after transition
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        /**
         * Saves the content from the modal to Firestore.
         */
        window.saveContent = async function() {
            const subjectId = document.getElementById('modalSubjectId').value;
            const content = document.getElementById('contentInput').value.trim();
            const saveButton = document.getElementById('saveButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            
            if (!content) {
                showMessage("Please enter some content before saving.", 'error', 3000);
                saveButton.textContent = 'Save Entry';
                saveButton.disabled = false;
                return;
            }

            try {
                closeModal();
                showMessage("Saving diary entry...", 'info', 0);
                
                const collectionRef = collection(db, getDiaryCollectionPath());
                
                const subject = globalState.classData[globalState.currentClassId].subjects.find(s => s.id === subjectId);
                
                const data = {
                    classId: globalState.currentClassId,
                    className: globalState.classData[globalState.currentClassId].name,
                    subjectId: subjectId,
                    subjectName: subject.name,
                    teacher: subject.teacher,
                    date: getDiaryDate(),
                    content: content,
                    timestamp: serverTimestamp() // Adds the server-side timestamp
                };

                // Create a unique document ID based on class-subject-date to prevent duplicates
                const uniqueDocId = `${globalState.currentClassId}-${subjectId}-${getDiaryDate()}`;
                const docRef = doc(db, getDiaryCollectionPath(), uniqueDocId);
                
                // Use setDoc with the predefined ID. Firestore handles creation vs. update automatically.
                await setDoc(docRef, data);

                showMessage("Diary entry saved successfully! Refreshing view...", 'success', 4000);

            } catch (error) {
                console.error("Error saving content:", error);
                showMessage(`Failed to save entry: ${error.message}`, 'error', 0);
            } finally {
                saveButton.textContent = 'Save Entry';
                saveButton.disabled = false;
            }
        };

        // --- Initialization and Authentication ---

        /**
         * Main initialization function
         */
        async function initializeApp() {
            updateDateDisplay();
            showMessage("Connecting to Firebase...", 'info', 0);
            
            // 1. Authenticate
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showMessage("Authentication failed. Data will not sync. " + error.message, 'error', 0);
            }

            // 2. Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    globalState.userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = `User ID: ${user.uid.substring(0, 8)}-...`;
                    globalState.isAuthReady = true;
                    showMessage("Diary initialized. Ready for entries.", 'info', 3000);
                    
                    // 3. Initialize Class Data and Listeners
                    initializeClasses();
                } else {
                    globalState.userId = null;
                    globalState.isAuthReady = true; // Still ready, but logged out
                    document.getElementById('userIdDisplay').textContent = 'User ID: N/A';
                }
            });
        }

        // Start the application
        initializeApp();

    </script>
</body>
</html>
